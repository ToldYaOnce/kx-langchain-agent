"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GoalStateManager = void 0;
class GoalStateManager {
    constructor() {
        this.states = new Map();
    }
    /**
     * Get or create goal state for a conversation
     */
    getGoalState(sessionId, userId, tenantId) {
        const key = `${tenantId}:${userId}:${sessionId}`;
        if (!this.states.has(key)) {
            const newState = {
                sessionId,
                userId,
                tenantId,
                collectedData: {},
                activeGoals: [],
                completedGoals: [],
                declinedGoals: [],
                messageCount: 0,
                interestLevel: 'medium',
                urgencyLevel: 'normal',
                startedAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };
            this.states.set(key, newState);
        }
        return this.states.get(key);
    }
    /**
     * Update goal state
     */
    updateGoalState(state) {
        const key = `${state.tenantId}:${state.userId}:${state.sessionId}`;
        state.lastUpdated = new Date().toISOString();
        this.states.set(key, state);
    }
    /**
     * Increment message count and update conversation context
     */
    incrementMessage(sessionId, userId, tenantId, interestLevel, urgencyLevel) {
        const state = this.getGoalState(sessionId, userId, tenantId);
        state.messageCount++;
        if (interestLevel) {
            state.interestLevel = interestLevel;
        }
        if (urgencyLevel) {
            state.urgencyLevel = urgencyLevel;
        }
        this.updateGoalState(state);
        return state;
    }
    /**
     * Mark information as collected
     */
    collectInformation(sessionId, userId, tenantId, field, value, validated = false) {
        const state = this.getGoalState(sessionId, userId, tenantId);
        state.collectedData[field] = {
            value,
            validated,
            collectedAt: new Date().toISOString()
        };
        this.updateGoalState(state);
        return state;
    }
    /**
     * Mark a goal as completed
     */
    completeGoal(sessionId, userId, tenantId, goalId, method) {
        const state = this.getGoalState(sessionId, userId, tenantId);
        if (!state.completedGoals.includes(goalId)) {
            state.completedGoals.push(goalId);
        }
        // Remove from active goals
        state.activeGoals = state.activeGoals.filter(id => id !== goalId);
        // Track completion
        state.lastGoalAttempt = {
            goalId,
            timestamp: new Date().toISOString(),
            successful: true
        };
        this.updateGoalState(state);
        return state;
    }
    /**
     * Mark a goal as declined by user
     */
    declineGoal(sessionId, userId, tenantId, goalId) {
        const state = this.getGoalState(sessionId, userId, tenantId);
        if (!state.declinedGoals.includes(goalId)) {
            state.declinedGoals.push(goalId);
        }
        // Remove from active goals
        state.activeGoals = state.activeGoals.filter(id => id !== goalId);
        // Track decline
        state.lastGoalAttempt = {
            goalId,
            timestamp: new Date().toISOString(),
            successful: false
        };
        this.updateGoalState(state);
        return state;
    }
    /**
     * Activate a goal for pursuit
     */
    activateGoal(sessionId, userId, tenantId, goalId) {
        const state = this.getGoalState(sessionId, userId, tenantId);
        if (!state.activeGoals.includes(goalId) &&
            !state.completedGoals.includes(goalId)) {
            state.activeGoals.push(goalId);
        }
        this.updateGoalState(state);
        return state;
    }
    /**
     * Check if a goal condition is met
     */
    evaluateCondition(state, condition) {
        switch (condition.type) {
            case 'message_count':
                return this.compareValues(state.messageCount, condition.operator, condition.value);
            case 'interest_level':
                const interestValues = { low: 1, medium: 2, high: 3 };
                const currentInterest = interestValues[state.interestLevel];
                const targetInterest = typeof condition.value === 'string'
                    ? interestValues[condition.value]
                    : condition.value;
                return this.compareValues(currentInterest, condition.operator, targetInterest);
            case 'urgency_level':
                const urgencyValues = { casual: 1, normal: 2, urgent: 3 };
                const currentUrgency = urgencyValues[state.urgencyLevel];
                const targetUrgency = typeof condition.value === 'string'
                    ? urgencyValues[condition.value]
                    : condition.value;
                return this.compareValues(currentUrgency, condition.operator, targetUrgency);
            case 'has_info':
                const hasInfo = String(condition.value) in state.collectedData;
                return condition.operator === 'equals' ? hasInfo : !hasInfo;
            case 'time_elapsed':
                const startTime = new Date(state.startedAt).getTime();
                const now = new Date().getTime();
                const elapsed = (now - startTime) / (1000 * 60); // minutes
                return this.compareValues(elapsed, condition.operator, condition.value);
            default:
                return false;
        }
    }
    /**
     * Helper method to compare values based on operator
     */
    compareValues(actual, operator, expected) {
        switch (operator) {
            case 'equals':
                return actual === expected;
            case 'greater_than':
                return actual > expected;
            case 'less_than':
                return actual < expected;
            case 'contains':
                return String(actual).toLowerCase().includes(String(expected).toLowerCase());
            case 'not_contains':
                return !String(actual).toLowerCase().includes(String(expected).toLowerCase());
            default:
                return false;
        }
    }
    /**
     * Check if user has all required information for lead generation
     */
    isLeadComplete(state, requiredFields = ['email', 'phone', 'fullName']) {
        return requiredFields.every(field => field in state.collectedData &&
            state.collectedData[field].validated !== false);
    }
    /**
     * Get summary of goal state for debugging
     */
    getStateSummary(sessionId, userId, tenantId) {
        const state = this.getGoalState(sessionId, userId, tenantId);
        return {
            messageCount: state.messageCount,
            interestLevel: state.interestLevel,
            urgencyLevel: state.urgencyLevel,
            collectedFields: Object.keys(state.collectedData),
            activeGoals: state.activeGoals,
            completedGoals: state.completedGoals,
            declinedGoals: state.declinedGoals,
            isLeadComplete: this.isLeadComplete(state),
            sessionAge: Math.round((new Date().getTime() - new Date(state.startedAt).getTime()) / (1000 * 60)) + ' minutes'
        };
    }
    /**
     * Clear state (for testing or session reset)
     */
    clearState(sessionId, userId, tenantId) {
        const key = `${tenantId}:${userId}:${sessionId}`;
        this.states.delete(key);
    }
    /**
     * Get all active states (for monitoring/debugging)
     */
    getAllStates() {
        return Array.from(this.states.values());
    }
}
exports.GoalStateManager = GoalStateManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29hbC1zdGF0ZS1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpYi9nb2FsLXN0YXRlLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBT0EsTUFBYSxnQkFBZ0I7SUFBN0I7UUFDVSxXQUFNLEdBQXVDLElBQUksR0FBRyxFQUFFLENBQUM7SUEwUWpFLENBQUM7SUF4UUM7O09BRUc7SUFDSCxZQUFZLENBQUMsU0FBaUIsRUFBRSxNQUFjLEVBQUUsUUFBZ0I7UUFDOUQsTUFBTSxHQUFHLEdBQUcsR0FBRyxRQUFRLElBQUksTUFBTSxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBRWpELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzFCLE1BQU0sUUFBUSxHQUEwQjtnQkFDdEMsU0FBUztnQkFDVCxNQUFNO2dCQUNOLFFBQVE7Z0JBQ1IsYUFBYSxFQUFFLEVBQUU7Z0JBQ2pCLFdBQVcsRUFBRSxFQUFFO2dCQUNmLGNBQWMsRUFBRSxFQUFFO2dCQUNsQixhQUFhLEVBQUUsRUFBRTtnQkFDakIsWUFBWSxFQUFFLENBQUM7Z0JBQ2YsYUFBYSxFQUFFLFFBQVE7Z0JBQ3ZCLFlBQVksRUFBRSxRQUFRO2dCQUN0QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7Z0JBQ25DLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTthQUN0QyxDQUFDO1lBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBRSxDQUFDO0lBQy9CLENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWUsQ0FBQyxLQUE0QjtRQUMxQyxNQUFNLEdBQUcsR0FBRyxHQUFHLEtBQUss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RUQ7O09BRUc7SUFDSCxVQUFVLENBQUMsU0FBaUIsRUFBRSxNQUFjLEVBQUUsUUFBZ0I7UUFDNUQsTUFBTSxHQUFHLEdBQUcsR0FBRyxRQUFRLElBQUksTUFBTSxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ2pELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVk7UUFDVixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQzFDLENBQUM7Q0FDRjtBQTNRRCw0Q0EyUUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFxyXG4gIENvbnZlcnNhdGlvbkdvYWxTdGF0ZSwgXHJcbiAgQ29udmVyc2F0aW9uR29hbCwgXHJcbiAgR29hbENvbmZpZ3VyYXRpb24sXHJcbiAgR29hbENvbmRpdGlvbiBcclxufSBmcm9tICcuLi90eXBlcy9nb2Fscy5qcyc7XHJcblxyXG5leHBvcnQgY2xhc3MgR29hbFN0YXRlTWFuYWdlciB7XHJcbiAgcHJpdmF0ZSBzdGF0ZXM6IE1hcDxzdHJpbmcsIENvbnZlcnNhdGlvbkdvYWxTdGF0ZT4gPSBuZXcgTWFwKCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBvciBjcmVhdGUgZ29hbCBzdGF0ZSBmb3IgYSBjb252ZXJzYXRpb25cclxuICAgKi9cclxuICBnZXRHb2FsU3RhdGUoc2Vzc2lvbklkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCB0ZW5hbnRJZDogc3RyaW5nKTogQ29udmVyc2F0aW9uR29hbFN0YXRlIHtcclxuICAgIGNvbnN0IGtleSA9IGAke3RlbmFudElkfToke3VzZXJJZH06JHtzZXNzaW9uSWR9YDtcclxuICAgIFxyXG4gICAgaWYgKCF0aGlzLnN0YXRlcy5oYXMoa2V5KSkge1xyXG4gICAgICBjb25zdCBuZXdTdGF0ZTogQ29udmVyc2F0aW9uR29hbFN0YXRlID0ge1xyXG4gICAgICAgIHNlc3Npb25JZCxcclxuICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgdGVuYW50SWQsXHJcbiAgICAgICAgY29sbGVjdGVkRGF0YToge30sXHJcbiAgICAgICAgYWN0aXZlR29hbHM6IFtdLFxyXG4gICAgICAgIGNvbXBsZXRlZEdvYWxzOiBbXSxcclxuICAgICAgICBkZWNsaW5lZEdvYWxzOiBbXSxcclxuICAgICAgICBtZXNzYWdlQ291bnQ6IDAsXHJcbiAgICAgICAgaW50ZXJlc3RMZXZlbDogJ21lZGl1bScsXHJcbiAgICAgICAgdXJnZW5jeUxldmVsOiAnbm9ybWFsJyxcclxuICAgICAgICBzdGFydGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICBsYXN0VXBkYXRlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMuc3RhdGVzLnNldChrZXksIG5ld1N0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5zdGF0ZXMuZ2V0KGtleSkhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlIGdvYWwgc3RhdGVcclxuICAgKi9cclxuICB1cGRhdGVHb2FsU3RhdGUoc3RhdGU6IENvbnZlcnNhdGlvbkdvYWxTdGF0ZSk6IHZvaWQge1xyXG4gICAgY29uc3Qga2V5ID0gYCR7c3RhdGUudGVuYW50SWR9OiR7c3RhdGUudXNlcklkfToke3N0YXRlLnNlc3Npb25JZH1gO1xyXG4gICAgc3RhdGUubGFzdFVwZGF0ZWQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgICB0aGlzLnN0YXRlcy5zZXQoa2V5LCBzdGF0ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbmNyZW1lbnQgbWVzc2FnZSBjb3VudCBhbmQgdXBkYXRlIGNvbnZlcnNhdGlvbiBjb250ZXh0XHJcbiAgICovXHJcbiAgaW5jcmVtZW50TWVzc2FnZShcclxuICAgIHNlc3Npb25JZDogc3RyaW5nLCBcclxuICAgIHVzZXJJZDogc3RyaW5nLCBcclxuICAgIHRlbmFudElkOiBzdHJpbmcsXHJcbiAgICBpbnRlcmVzdExldmVsPzogJ2hpZ2gnIHwgJ21lZGl1bScgfCAnbG93JyxcclxuICAgIHVyZ2VuY3lMZXZlbD86ICd1cmdlbnQnIHwgJ25vcm1hbCcgfCAnY2FzdWFsJ1xyXG4gICk6IENvbnZlcnNhdGlvbkdvYWxTdGF0ZSB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0R29hbFN0YXRlKHNlc3Npb25JZCwgdXNlcklkLCB0ZW5hbnRJZCk7XHJcbiAgICBzdGF0ZS5tZXNzYWdlQ291bnQrKztcclxuICAgIFxyXG4gICAgaWYgKGludGVyZXN0TGV2ZWwpIHtcclxuICAgICAgc3RhdGUuaW50ZXJlc3RMZXZlbCA9IGludGVyZXN0TGV2ZWw7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGlmICh1cmdlbmN5TGV2ZWwpIHtcclxuICAgICAgc3RhdGUudXJnZW5jeUxldmVsID0gdXJnZW5jeUxldmVsO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICB0aGlzLnVwZGF0ZUdvYWxTdGF0ZShzdGF0ZSk7XHJcbiAgICByZXR1cm4gc3RhdGU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNYXJrIGluZm9ybWF0aW9uIGFzIGNvbGxlY3RlZFxyXG4gICAqL1xyXG4gIGNvbGxlY3RJbmZvcm1hdGlvbihcclxuICAgIHNlc3Npb25JZDogc3RyaW5nLFxyXG4gICAgdXNlcklkOiBzdHJpbmcsIFxyXG4gICAgdGVuYW50SWQ6IHN0cmluZyxcclxuICAgIGZpZWxkOiBzdHJpbmcsXHJcbiAgICB2YWx1ZTogYW55LFxyXG4gICAgdmFsaWRhdGVkOiBib29sZWFuID0gZmFsc2VcclxuICApOiBDb252ZXJzYXRpb25Hb2FsU3RhdGUge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLmdldEdvYWxTdGF0ZShzZXNzaW9uSWQsIHVzZXJJZCwgdGVuYW50SWQpO1xyXG4gICAgc3RhdGUuY29sbGVjdGVkRGF0YVtmaWVsZF0gPSB7XHJcbiAgICAgIHZhbHVlLFxyXG4gICAgICB2YWxpZGF0ZWQsXHJcbiAgICAgIGNvbGxlY3RlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH07XHJcbiAgICBcclxuICAgIHRoaXMudXBkYXRlR29hbFN0YXRlKHN0YXRlKTtcclxuICAgIHJldHVybiBzdGF0ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcmsgYSBnb2FsIGFzIGNvbXBsZXRlZFxyXG4gICAqL1xyXG4gIGNvbXBsZXRlR29hbChcclxuICAgIHNlc3Npb25JZDogc3RyaW5nLFxyXG4gICAgdXNlcklkOiBzdHJpbmcsXHJcbiAgICB0ZW5hbnRJZDogc3RyaW5nLFxyXG4gICAgZ29hbElkOiBzdHJpbmcsXHJcbiAgICBtZXRob2Q/OiBzdHJpbmdcclxuICApOiBDb252ZXJzYXRpb25Hb2FsU3RhdGUge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLmdldEdvYWxTdGF0ZShzZXNzaW9uSWQsIHVzZXJJZCwgdGVuYW50SWQpO1xyXG4gICAgXHJcbiAgICBpZiAoIXN0YXRlLmNvbXBsZXRlZEdvYWxzLmluY2x1ZGVzKGdvYWxJZCkpIHtcclxuICAgICAgc3RhdGUuY29tcGxldGVkR29hbHMucHVzaChnb2FsSWQpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBSZW1vdmUgZnJvbSBhY3RpdmUgZ29hbHNcclxuICAgIHN0YXRlLmFjdGl2ZUdvYWxzID0gc3RhdGUuYWN0aXZlR29hbHMuZmlsdGVyKGlkID0+IGlkICE9PSBnb2FsSWQpO1xyXG4gICAgXHJcbiAgICAvLyBUcmFjayBjb21wbGV0aW9uXHJcbiAgICBzdGF0ZS5sYXN0R29hbEF0dGVtcHQgPSB7XHJcbiAgICAgIGdvYWxJZCxcclxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgIHN1Y2Nlc3NmdWw6IHRydWVcclxuICAgIH07XHJcbiAgICBcclxuICAgIHRoaXMudXBkYXRlR29hbFN0YXRlKHN0YXRlKTtcclxuICAgIHJldHVybiBzdGF0ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcmsgYSBnb2FsIGFzIGRlY2xpbmVkIGJ5IHVzZXJcclxuICAgKi9cclxuICBkZWNsaW5lR29hbChcclxuICAgIHNlc3Npb25JZDogc3RyaW5nLFxyXG4gICAgdXNlcklkOiBzdHJpbmcsXHJcbiAgICB0ZW5hbnRJZDogc3RyaW5nLFxyXG4gICAgZ29hbElkOiBzdHJpbmdcclxuICApOiBDb252ZXJzYXRpb25Hb2FsU3RhdGUge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLmdldEdvYWxTdGF0ZShzZXNzaW9uSWQsIHVzZXJJZCwgdGVuYW50SWQpO1xyXG4gICAgXHJcbiAgICBpZiAoIXN0YXRlLmRlY2xpbmVkR29hbHMuaW5jbHVkZXMoZ29hbElkKSkge1xyXG4gICAgICBzdGF0ZS5kZWNsaW5lZEdvYWxzLnB1c2goZ29hbElkKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gUmVtb3ZlIGZyb20gYWN0aXZlIGdvYWxzXHJcbiAgICBzdGF0ZS5hY3RpdmVHb2FscyA9IHN0YXRlLmFjdGl2ZUdvYWxzLmZpbHRlcihpZCA9PiBpZCAhPT0gZ29hbElkKTtcclxuICAgIFxyXG4gICAgLy8gVHJhY2sgZGVjbGluZVxyXG4gICAgc3RhdGUubGFzdEdvYWxBdHRlbXB0ID0ge1xyXG4gICAgICBnb2FsSWQsXHJcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICBzdWNjZXNzZnVsOiBmYWxzZVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdGhpcy51cGRhdGVHb2FsU3RhdGUoc3RhdGUpO1xyXG4gICAgcmV0dXJuIHN0YXRlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWN0aXZhdGUgYSBnb2FsIGZvciBwdXJzdWl0XHJcbiAgICovXHJcbiAgYWN0aXZhdGVHb2FsKFxyXG4gICAgc2Vzc2lvbklkOiBzdHJpbmcsXHJcbiAgICB1c2VySWQ6IHN0cmluZyxcclxuICAgIHRlbmFudElkOiBzdHJpbmcsXHJcbiAgICBnb2FsSWQ6IHN0cmluZ1xyXG4gICk6IENvbnZlcnNhdGlvbkdvYWxTdGF0ZSB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0R29hbFN0YXRlKHNlc3Npb25JZCwgdXNlcklkLCB0ZW5hbnRJZCk7XHJcbiAgICBcclxuICAgIGlmICghc3RhdGUuYWN0aXZlR29hbHMuaW5jbHVkZXMoZ29hbElkKSAmJiBcclxuICAgICAgICAhc3RhdGUuY29tcGxldGVkR29hbHMuaW5jbHVkZXMoZ29hbElkKSkge1xyXG4gICAgICBzdGF0ZS5hY3RpdmVHb2Fscy5wdXNoKGdvYWxJZCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHRoaXMudXBkYXRlR29hbFN0YXRlKHN0YXRlKTtcclxuICAgIHJldHVybiBzdGF0ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENoZWNrIGlmIGEgZ29hbCBjb25kaXRpb24gaXMgbWV0XHJcbiAgICovXHJcbiAgZXZhbHVhdGVDb25kaXRpb24oc3RhdGU6IENvbnZlcnNhdGlvbkdvYWxTdGF0ZSwgY29uZGl0aW9uOiBHb2FsQ29uZGl0aW9uKTogYm9vbGVhbiB7XHJcbiAgICBzd2l0Y2ggKGNvbmRpdGlvbi50eXBlKSB7XHJcbiAgICAgIGNhc2UgJ21lc3NhZ2VfY291bnQnOlxyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbXBhcmVWYWx1ZXMoc3RhdGUubWVzc2FnZUNvdW50LCBjb25kaXRpb24ub3BlcmF0b3IsIGNvbmRpdGlvbi52YWx1ZSk7XHJcbiAgICAgICAgXHJcbiAgICAgIGNhc2UgJ2ludGVyZXN0X2xldmVsJzpcclxuICAgICAgICBjb25zdCBpbnRlcmVzdFZhbHVlcyA9IHsgbG93OiAxLCBtZWRpdW06IDIsIGhpZ2g6IDMgfTtcclxuICAgICAgICBjb25zdCBjdXJyZW50SW50ZXJlc3QgPSBpbnRlcmVzdFZhbHVlc1tzdGF0ZS5pbnRlcmVzdExldmVsXTtcclxuICAgICAgICBjb25zdCB0YXJnZXRJbnRlcmVzdCA9IHR5cGVvZiBjb25kaXRpb24udmFsdWUgPT09ICdzdHJpbmcnIFxyXG4gICAgICAgICAgPyBpbnRlcmVzdFZhbHVlc1tjb25kaXRpb24udmFsdWUgYXMga2V5b2YgdHlwZW9mIGludGVyZXN0VmFsdWVzXVxyXG4gICAgICAgICAgOiBjb25kaXRpb24udmFsdWU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY29tcGFyZVZhbHVlcyhjdXJyZW50SW50ZXJlc3QsIGNvbmRpdGlvbi5vcGVyYXRvciwgdGFyZ2V0SW50ZXJlc3QpO1xyXG4gICAgICAgIFxyXG4gICAgICBjYXNlICd1cmdlbmN5X2xldmVsJzpcclxuICAgICAgICBjb25zdCB1cmdlbmN5VmFsdWVzID0geyBjYXN1YWw6IDEsIG5vcm1hbDogMiwgdXJnZW50OiAzIH07XHJcbiAgICAgICAgY29uc3QgY3VycmVudFVyZ2VuY3kgPSB1cmdlbmN5VmFsdWVzW3N0YXRlLnVyZ2VuY3lMZXZlbF07XHJcbiAgICAgICAgY29uc3QgdGFyZ2V0VXJnZW5jeSA9IHR5cGVvZiBjb25kaXRpb24udmFsdWUgPT09ICdzdHJpbmcnXHJcbiAgICAgICAgICA/IHVyZ2VuY3lWYWx1ZXNbY29uZGl0aW9uLnZhbHVlIGFzIGtleW9mIHR5cGVvZiB1cmdlbmN5VmFsdWVzXVxyXG4gICAgICAgICAgOiBjb25kaXRpb24udmFsdWU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY29tcGFyZVZhbHVlcyhjdXJyZW50VXJnZW5jeSwgY29uZGl0aW9uLm9wZXJhdG9yLCB0YXJnZXRVcmdlbmN5KTtcclxuICAgICAgICBcclxuICAgICAgY2FzZSAnaGFzX2luZm8nOlxyXG4gICAgICAgIGNvbnN0IGhhc0luZm8gPSBTdHJpbmcoY29uZGl0aW9uLnZhbHVlKSBpbiBzdGF0ZS5jb2xsZWN0ZWREYXRhO1xyXG4gICAgICAgIHJldHVybiBjb25kaXRpb24ub3BlcmF0b3IgPT09ICdlcXVhbHMnID8gaGFzSW5mbyA6ICFoYXNJbmZvO1xyXG4gICAgICAgIFxyXG4gICAgICBjYXNlICd0aW1lX2VsYXBzZWQnOlxyXG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IG5ldyBEYXRlKHN0YXRlLnN0YXJ0ZWRBdCkuZ2V0VGltZSgpO1xyXG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xyXG4gICAgICAgIGNvbnN0IGVsYXBzZWQgPSAobm93IC0gc3RhcnRUaW1lKSAvICgxMDAwICogNjApOyAvLyBtaW51dGVzXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY29tcGFyZVZhbHVlcyhlbGFwc2VkLCBjb25kaXRpb24ub3BlcmF0b3IsIGNvbmRpdGlvbi52YWx1ZSk7XHJcbiAgICAgICAgXHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSGVscGVyIG1ldGhvZCB0byBjb21wYXJlIHZhbHVlcyBiYXNlZCBvbiBvcGVyYXRvclxyXG4gICAqL1xyXG4gIHByaXZhdGUgY29tcGFyZVZhbHVlcyhhY3R1YWw6IGFueSwgb3BlcmF0b3I6IHN0cmluZywgZXhwZWN0ZWQ6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgc3dpdGNoIChvcGVyYXRvcikge1xyXG4gICAgICBjYXNlICdlcXVhbHMnOlxyXG4gICAgICAgIHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdncmVhdGVyX3RoYW4nOlxyXG4gICAgICAgIHJldHVybiBhY3R1YWwgPiBleHBlY3RlZDtcclxuICAgICAgY2FzZSAnbGVzc190aGFuJzpcclxuICAgICAgICByZXR1cm4gYWN0dWFsIDwgZXhwZWN0ZWQ7XHJcbiAgICAgIGNhc2UgJ2NvbnRhaW5zJzpcclxuICAgICAgICByZXR1cm4gU3RyaW5nKGFjdHVhbCkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhTdHJpbmcoZXhwZWN0ZWQpLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICBjYXNlICdub3RfY29udGFpbnMnOlxyXG4gICAgICAgIHJldHVybiAhU3RyaW5nKGFjdHVhbCkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhTdHJpbmcoZXhwZWN0ZWQpLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENoZWNrIGlmIHVzZXIgaGFzIGFsbCByZXF1aXJlZCBpbmZvcm1hdGlvbiBmb3IgbGVhZCBnZW5lcmF0aW9uXHJcbiAgICovXHJcbiAgaXNMZWFkQ29tcGxldGUoc3RhdGU6IENvbnZlcnNhdGlvbkdvYWxTdGF0ZSwgcmVxdWlyZWRGaWVsZHM6IHN0cmluZ1tdID0gWydlbWFpbCcsICdwaG9uZScsICdmdWxsTmFtZSddKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gcmVxdWlyZWRGaWVsZHMuZXZlcnkoZmllbGQgPT4gXHJcbiAgICAgIGZpZWxkIGluIHN0YXRlLmNvbGxlY3RlZERhdGEgJiYgXHJcbiAgICAgIHN0YXRlLmNvbGxlY3RlZERhdGFbZmllbGRdLnZhbGlkYXRlZCAhPT0gZmFsc2VcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgc3VtbWFyeSBvZiBnb2FsIHN0YXRlIGZvciBkZWJ1Z2dpbmdcclxuICAgKi9cclxuICBnZXRTdGF0ZVN1bW1hcnkoc2Vzc2lvbklkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCB0ZW5hbnRJZDogc3RyaW5nKTogYW55IHtcclxuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5nZXRHb2FsU3RhdGUoc2Vzc2lvbklkLCB1c2VySWQsIHRlbmFudElkKTtcclxuICAgIFxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbWVzc2FnZUNvdW50OiBzdGF0ZS5tZXNzYWdlQ291bnQsXHJcbiAgICAgIGludGVyZXN0TGV2ZWw6IHN0YXRlLmludGVyZXN0TGV2ZWwsXHJcbiAgICAgIHVyZ2VuY3lMZXZlbDogc3RhdGUudXJnZW5jeUxldmVsLFxyXG4gICAgICBjb2xsZWN0ZWRGaWVsZHM6IE9iamVjdC5rZXlzKHN0YXRlLmNvbGxlY3RlZERhdGEpLFxyXG4gICAgICBhY3RpdmVHb2Fsczogc3RhdGUuYWN0aXZlR29hbHMsXHJcbiAgICAgIGNvbXBsZXRlZEdvYWxzOiBzdGF0ZS5jb21wbGV0ZWRHb2FscyxcclxuICAgICAgZGVjbGluZWRHb2Fsczogc3RhdGUuZGVjbGluZWRHb2FscyxcclxuICAgICAgaXNMZWFkQ29tcGxldGU6IHRoaXMuaXNMZWFkQ29tcGxldGUoc3RhdGUpLFxyXG4gICAgICBzZXNzaW9uQWdlOiBNYXRoLnJvdW5kKChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIG5ldyBEYXRlKHN0YXRlLnN0YXJ0ZWRBdCkuZ2V0VGltZSgpKSAvICgxMDAwICogNjApKSArICcgbWludXRlcydcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhciBzdGF0ZSAoZm9yIHRlc3Rpbmcgb3Igc2Vzc2lvbiByZXNldClcclxuICAgKi9cclxuICBjbGVhclN0YXRlKHNlc3Npb25JZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZywgdGVuYW50SWQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgY29uc3Qga2V5ID0gYCR7dGVuYW50SWR9OiR7dXNlcklkfToke3Nlc3Npb25JZH1gO1xyXG4gICAgdGhpcy5zdGF0ZXMuZGVsZXRlKGtleSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgYWxsIGFjdGl2ZSBzdGF0ZXMgKGZvciBtb25pdG9yaW5nL2RlYnVnZ2luZylcclxuICAgKi9cclxuICBnZXRBbGxTdGF0ZXMoKTogQ29udmVyc2F0aW9uR29hbFN0YXRlW10ge1xyXG4gICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5zdGF0ZXMudmFsdWVzKCkpO1xyXG4gIH1cclxufVxyXG4iXX0=